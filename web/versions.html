<!DOCTYPE html>
<!-- 
This page automatically pulls version information from VERSIONS.json in the live GitHub repository, replacing manual updates on:
- https://github.com/chylex/Discord-History-Tracker/wiki/Old-Versions
- https://github.com/chylex/Discord-History-Tracker/wiki/Release-Notes
-->
<!-- PR Author: TBH IMO this entire page can probably actually be replaced with a link to the branch commit history. I've never used an old version even once in many years, and users at this point are already choosing greater difficulty. -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="robots" content="index,follow">
    <meta name="author" content="chylex">
    <meta name="description" content="Discord History Tracker - Browser script to save history of Discord servers and private conversations">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Discord History Tracker</title>
    
    <link href="style.css" type="text/css" rel="stylesheet">
    
    <script src="versions.js"></script>
  </head>
  <body>
    <div class="inner">
      <h1>Discord History Tracker <span class="version">Web&nbsp;Version&nbsp;History</span>&nbsp;<!--<span class="bar">|</span>&nbsp;<span class="notes"><a href="./index.html">Main Page</a></span>--></h1>
      <p>This page lists old versions of the browser version of DHT. For the latest version, please see the <a href="./index.html">main page</a>.</p>
      
      <noscript><p>This page requires JavaScript. You can also view the <a href="https://github.com/will-ca/Discord-History-Tracker/tree/main-browser/VERSIONS.json">raw version history data</a>.</p></noscript>
      <!-- TODO for PR: Update the fallback link. -->
      
      <h2>Current Version</h2>
      
      <span id="version_current">
        <p>Loading…</p>
      </span>
      
      <h2>Past Versions</h2>
      
      <p>If you need to use an older version of DHT, for example when you haven't received a Discord update yet, use one of the links below.</p>
      <p>The <strong>userscript</strong> version will install into your userscript manager, however <strong>it will not update automatically</strong>. Click the link to prompt an installation.</p>
      <p>The <strong>manual</strong> version shows the tracker code, which you can copy/paste into the browser or app console, as described on the <a href="./index.html">main page</a>.</p>
      <p>To use the <strong>viewer</strong>, you must right-click the link and use <strong>Save link as...</strong> to download it, otherwise it will not work. Using old viewers is not recommended, as the most recent viewer should be able to open archives made in any of the old trackers.</p>
      
      <span id="versions_old">
        <p>Loading…</p>
      </span>
      
    </div>
    
    <script type="text/javascript">
      (async function (ctx) {
        ctx.current = document.getElementById("version_current")
        ctx.olds = document.getElementById("versions_old")
        
        ctx.createElementText = function (tagName, text = null) {
          let ele = document.createElement(tagName)
          if (text)
            ele.innerText = text
          return ele
        }
        
        ctx.renderVersion = function (v_array) {
          console.log(`Rendering ${v_array[0]} release notes.`)
          let frag = document.createDocumentFragment()
          frag.appendChild(
            // Version number/name.
            ctx.createElementText('h3', v_array[0])
          )
          if (v_array[1]) {
            let commit = v_array[1]
            // // Time of commit from GH API.
            // // Works but is heavily rate-limited without auth (60/hour). See below.
            // let p_time = frag.appendChild(
            //   ctx.createElementText("p", "Loading…")
            // )
            // ctx.ghCommitDate(commit).then(date =>
            //   p_time.innerText = date.toLocaleDateString()
            // )
            let p_links = frag.appendChild(
              ctx.createElementText("p")
            )
            // Links to each version.
            for (let [display, path, add_bar] of [
              ["Userscript", "/bld/track.user.js", true],
              ["Manual", "/bld/track.js", true],
              ["Viewer", "/bld/viewer.html", true],
              [commit.slice(0, 6), null, false]
            ]) {
              let a = p_links.appendChild(
                ctx.createElementText('a', display)
              )
              a.href = (path === null) ?
                ctx.ghCommitUrl(commit) :
                ghUrl(path, commit)
              if (add_bar) {
                p_links.innerHTML += " | "
              }
            }
          }
          if (v_array.length > 2) {
            // Change notes.
            let div = frag.appendChild(
              ctx.createElementText("div")
            )
            div.classList.add("quote")
            let ul = div.appendChild(
              ctx.createElementText("ul")
            )
            for (let i=2; i< v_array.length; i++) {
              ul.appendChild(
                ctx.createElementText("li", v_array[i])
              )
            }
          }
          return frag
        }
        
        // // Works but is heavily rate-limited without auth (60/hour). See above.
        // ctx._ghCommitDate = async function (commit) {
        //   // This downloads quite a bit of data, and is arguably unnecessary.
        //   let url = `https://api.github.com/repos/${GH_REPO}/commits/${commit}`
        //   console.log(`Fetching commit ${commit.slice(0,6)}: ${url}`)
        //   let resp = await window.fetch(url)
        //   console.log(`Fetched commit ${commit.slice(0,6)}.`)
        //   let json = await resp.json()
        //   try {
        //     return new Date(json.commit.committer.date)
        //   } catch (e) {
        //     console.error(e)
        //     console.log(json)
        //     return new Date(0)
        //   }
        // }
        // ctx._lastDatePromise = null
        // ctx.ghCommitDate = function (commit) {
        //   // Chain API calls so GH can rate-limit.
        //   return (ctx._lastDatePromise === null) ?
        //     ctx._lastDatePromise = ctx._ghCommitDate(commit) :
        //     ctx._lastDatePromise = ctx._lastDatePromise.then(r =>
        //       ctx._ghCommitDate(commit)
        //     )
        // }
        
        ctx.ghCommitUrl = function(commit) {
          return `https://github.com/${GH_REPO}/commit/${commit}`
        }
        
        ctx.versions = await window.ajax_versions
        
        let current_r = ctx.renderVersion(ctx.versions.current)
        ctx.current.innerHTML = ""
        ctx.current.appendChild(current_r)
        
        let olds_r = document.createDocumentFragment()
        for (let i=0; i<ctx.versions.history.length; i++) {
          olds_r.appendChild(
            ctx.renderVersion(
              ctx.versions.history[i]
            )
          )
        }
        ctx.olds.innerHTML = ""
        ctx.olds.appendChild(olds_r)
        
      })(window.dht_ctx = {})
    </script>
  </body>
</html>
